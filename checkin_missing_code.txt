// ========================================
// åœ¨ Checkin.vue ç¬¬ 627 è¡Œä¹‹åæ·»åŠ ä»¥ä¸‹ä»£ç 
// ========================================

const router = useRouter();

// å“åº”å¼æ•°æ®
const loading = ref(false);
const showResult = ref(false);
const showSuccessModal = ref(false);
const showAlreadyChecked = ref(false);
const showDetailModal = ref(false);
const selectedRecord = ref<HealthTrend | null>(null);
const analysisResult = ref<AnalysisResult | null>(null);
const checkinHistory = ref<HealthTrend[]>([]);
const chartCanvas = ref<HTMLCanvasElement>();
const isEditMode = ref(false);
const todayCheckinTime = ref('');

// æ–°å¢ï¼šåˆ†æ­¥éª¤ç›¸å…³
const currentStep = ref(1);
const totalSteps = 3;

// æ–°å¢ï¼šç­›é€‰ç›¸å…³
const showFilter = ref(false);
const filterStartDate = ref('');
const filterEndDate = ref('');
const filterMinScore = ref(0);
const filterMaxScore = ref(100);
const filterSymptoms = ref<string[]>([]);

// æ–°å¢ï¼šå¯¼å‡ºç›¸å…³
const isExporting = ref(false);
const showExportDialog = ref(false);
const exportRange = ref<'current' | 'all'>('current');

// è®°å½•æ•°æ®
const checkinData = ref({
  sleepHours: 8,
  sleepTime: '23:00',
  symptoms: [] as string[],
  mood: 2,
  exerciseMinutes: 30,
  dietNotes: ''
});

// é€‰é¡¹æ•°æ®
const symptoms = [
  'å¤´ç—›', 'ç–²åŠ³', 'å¤±çœ ', 'é£Ÿæ¬²ä¸æŒ¯', 'è…¹èƒ€', 'ä¾¿ç§˜', 'è…¹æ³»',
  'å£å¹²', 'æ€•å†·', 'æ€•çƒ­', 'å‡ºæ±—å¤š', 'å¿ƒæ‚¸', 'æ— ç—‡çŠ¶'
];

const moods = [
  { emoji: 'ğŸ˜¢', name: 'å¾ˆå·®' },
  { emoji: 'ğŸ˜•', name: 'ä¸€èˆ¬' },
  { emoji: 'ğŸ˜Š', name: 'è‰¯å¥½' },
  { emoji: 'ğŸ˜„', name: 'å¾ˆå¥½' },
  { emoji: 'ğŸ¤©', name: 'æä½³' }
];

// è®¡ç®—å±æ€§
const isFormValid = computed(() => {
  return checkinData.value.sleepTime &&
         checkinData.value.sleepHours > 0 &&
         checkinData.value.mood !== null;
});

const isCurrentStepValid = computed(() => {
  switch (currentStep.value) {
    case 1:
      return checkinData.value.sleepTime && checkinData.value.sleepHours > 0;
    case 2:
      return checkinData.value.mood !== null;
    case 3:
      return true;
    default:
      return false;
  }
});

const filteredHistory = computed(() => {
  let filtered = [...checkinHistory.value];
  
  if (filterStartDate.value) {
    filtered = filtered.filter(r => r.date >= filterStartDate.value);
  }
  if (filterEndDate.value) {
    filtered = filtered.filter(r => r.date <= filterEndDate.value);
  }
  
  filtered = filtered.filter(r => {
    const score = r.healthScore ?? 0;
    return score >= filterMinScore.value && score <= filterMaxScore.value;
  });
  
  if (filterSymptoms.value.length > 0) {
    filtered = filtered.filter(r => {
      if (!r.symptoms || r.symptoms.length === 0) return false;
      return filterSymptoms.value.some(s => r.symptoms?.includes(s));
    });
  }
  
  return filtered;
});

// æ–¹æ³•
const goHome = () => {
  router.push('/dashboard');
};

const getCurrentDate = () => {
  return new Date().toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    weekday: 'long'
  });
};

const formatTime = (date: Date) => {
  return date.toLocaleString('zh-CN');
};

const toggleSymptom = (symptom: string) => {
  const index = checkinData.value.symptoms.indexOf(symptom);
  if (index > -1) {
    checkinData.value.symptoms.splice(index, 1);
  } else {
    checkinData.value.symptoms.push(symptom);
  }
};

const adjustExercise = (amount: number) => {
  const newValue = checkinData.value.exerciseMinutes + amount;
  if (newValue >= 0 && newValue <= 300) {
    checkinData.value.exerciseMinutes = newValue;
  }
};

const goToStep = (step: number) => {
  if (step < currentStep.value) {
    currentStep.value = step;
  } else if (step > currentStep.value) {
    if (isCurrentStepValid.value) {
      currentStep.value = step;
    } else {
      alert('è¯·å¡«å†™å½“å‰æ­¥éª¤çš„å¿…å¡«é¡¹');
    }
  }
};

const nextStep = () => {
  if (!isCurrentStepValid.value) {
    alert('è¯·å¡«å†™å½“å‰æ­¥éª¤çš„å¿…å¡«é¡¹');
    return;
  }
  if (currentStep.value < totalSteps) {
    currentStep.value++;
  }
};

const prevStep = () => {
  if (currentStep.value > 1) {
    currentStep.value--;
  }
};

const submitCheckin = async () => {
  if (!isFormValid.value || loading.value) return;
  loading.value = true;

  try {
    const submitData = {
      ...checkinData.value,
      sleepHours: Number(checkinData.value.sleepHours),
      mood: Number(checkinData.value.mood),
      exerciseMinutes: Number(checkinData.value.exerciseMinutes),
      date: new Date().toISOString().split('T')[0]
    };

    let response;
    if (isEditMode.value) {
      response = await updateTodayCheckin(submitData);
    } else {
      response = await postCheckin(submitData);
    }

    if (response.success) {
      const sampleRisks = [];
      
      if (checkinData.value.sleepHours < 6) {
        sampleRisks.push({
          level: 'é«˜',
          content: 'ç¡çœ æ—¶é—´ä¸¥é‡ä¸è¶³ï¼Œé•¿æœŸç¡çœ ä¸è¶³ä¼šå¯¼è‡´å…ç–«åŠ›ä¸‹é™ã€è®°å¿†åŠ›å‡é€€ï¼Œå»ºè®®å°½å¿«è°ƒæ•´ä½œæ¯'
        });
      } else if (checkinData.value.sleepHours < 7) {
        sampleRisks.push({
          level: 'ä¸­',
          content: 'ç¡çœ æ—¶é—´ç•¥æ˜¾ä¸è¶³ï¼Œå»ºè®®å¢åŠ ç¡çœ æ—¶é•¿è‡³7-8å°æ—¶ï¼Œä»¥ä¿è¯èº«ä½“å……åˆ†ä¼‘æ¯'
        });
      }
      
      if (checkinData.value.exerciseMinutes === 0) {
        sampleRisks.push({
          level: 'ä¸­',
          content: 'ä»Šæ—¥ç¼ºä¹è¿åŠ¨ï¼Œå»ºè®®æ¯å¤©è‡³å°‘è¿›è¡Œ30åˆ†é’Ÿçš„ä¸­ç­‰å¼ºåº¦è¿åŠ¨ï¼Œå¦‚å¿«èµ°ã€æ…¢è·‘ç­‰'
        });
      }
      
      if (checkinData.value.symptoms.includes('å¤±çœ ')) {
        sampleRisks.push({
          level: 'ä¸­',
          content: 'å‡ºç°å¤±çœ ç—‡çŠ¶ï¼Œå»ºè®®ç¡å‰é¿å…ä½¿ç”¨ç”µå­è®¾å¤‡ï¼Œå¯å°è¯•å†¥æƒ³æˆ–å¬è½»éŸ³ä¹æ”¾æ¾'
        });
      }
      
      if (checkinData.value.symptoms.includes('å¤´ç—›')) {
        sampleRisks.push({
          level: 'ä½',
          content: 'å‡ºç°å¤´ç—›ç—‡çŠ¶ï¼Œæ³¨æ„ä¼‘æ¯å’Œè¡¥å……æ°´åˆ†ï¼Œå¦‚æŒç»­ä¸ç¼“è§£å»ºè®®å°±åŒ»æ£€æŸ¥'
        });
      }
      
      analysisResult.value = {
        summary: response.summary || 'æ‚¨ä»Šå¤©çš„å¥åº·çŠ¶æ€è‰¯å¥½',
        suggestions: response.suggestions || [],
        healthScore: response.healthScore,
        tomorrowPlan: response.tomorrowPlan || 'ç»§ç»­ä¿æŒè‰¯å¥½çš„ä½œæ¯ä¹ æƒ¯',
        tomorrowTasks: [
          'æ—©ç¡æ—©èµ·ï¼Œä¿è¯8å°æ—¶ç¡çœ ',
          'é¥­åæ•£æ­¥30åˆ†é’Ÿ',
          'å¤šå–æ¸©æ°´ï¼Œä¿æŒæ°´åˆ†'
        ],
        risks: response.risks || sampleRisks
      };
      
      showSuccessModal.value = true;
      await loadCheckinHistory();
      
      if (!isEditMode.value) {
        isEditMode.value = true;
        todayCheckinTime.value = formatTime(new Date());
      }
    } else {
      const msg = response.message || 'æœªçŸ¥é”™è¯¯';
      if (msg.includes('ä»Šæ—¥å·²æ‰“å¡') || msg.includes('ä»Šæ—¥å·²è®°å½•')) {
        showAlreadyChecked.value = true;
      } else {
        alert((isEditMode.value ? 'ä¿®æ”¹' : 'è®°å½•') + 'å¤±è´¥ï¼š' + msg);
      }
    }
  } catch (error) {
    console.error('æäº¤è®°å½•å¤±è´¥:', error);
    alert('æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
  } finally {
    loading.value = false;
  }
};

const toggleFilter = () => {
  showFilter.value = !showFilter.value;
};

const applyFilter = () => {
  showFilter.value = false;
};

const clearFilter = () => {
  filterStartDate.value = '';
  filterEndDate.value = '';
  filterMinScore.value = 0;
  filterMaxScore.value = 100;
  filterSymptoms.value = [];
};

const toggleFilterSymptom = (symptom: string) => {
  const index = filterSymptoms.value.indexOf(symptom);
  if (index > -1) {
    filterSymptoms.value.splice(index, 1);
  } else {
    filterSymptoms.value.push(symptom);
  }
};

const openExportDialog = () => {
  showExportDialog.value = true;
};

const closeExportDialog = () => {
  showExportDialog.value = false;
};

const exportToPDF = async () => {
  if (isExporting.value) return;
  
  isExporting.value = true;
  closeExportDialog();
  
  try {
    const recordsToExport = exportRange.value === 'all' ? filteredHistory.value : filteredHistory.value.slice(0, 10);
    
    if (recordsToExport.length === 0) {
      alert('æ²¡æœ‰å¯å¯¼å‡ºçš„è®°å½•');
      return;
    }
    
    const exportContainer = document.createElement('div');
    exportContainer.style.position = 'absolute';
    exportContainer.style.left = '-9999px';
    exportContainer.style.width = '800px';
    exportContainer.style.background = 'white';
    exportContainer.style.padding = '40px';
    document.body.appendChild(exportContainer);
    
    exportContainer.innerHTML = `
      <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="font-size: 28px; color: #0f172a; margin-bottom: 10px;">å¥åº·è®°å½•æŠ¥å‘Š</h1>
        <p style="font-size: 14px; color: #64748b;">å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}</p>
        <p style="font-size: 14px; color: #64748b;">è®°å½•æ•°é‡ï¼š${recordsToExport.length} æ¡</p>
      </div>
    `;
    
    recordsToExport.forEach((record) => {
      const recordHtml = `
        <div style="margin-bottom: 20px; padding: 20px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <strong style="font-size: 16px;">${record.date}</strong>
            <span style="color: #10b981; font-weight: bold;">å¥åº·åˆ†: ${record.healthScore || '-'}</span>
          </div>
          <div style="font-size: 14px; color: #475569; line-height: 1.6;">
            <p>ç¡çœ : ${record.sleepHours || '-'}å°æ—¶ (${record.sleepTime || '-'}å…¥ç¡)</p>
            <p>è¿åŠ¨: ${record.exerciseMinutes || 0}åˆ†é’Ÿ</p>
            <p>å¿ƒæƒ…: ${getMoodInfo(record.mood).name}</p>
            ${record.symptoms && record.symptoms.length > 0 ? `<p>ç—‡çŠ¶: ${record.symptoms.join('ã€')}</p>` : ''}
            ${record.dietNotes ? `<p>é¥®é£Ÿ: ${record.dietNotes}</p>` : ''}
          </div>
        </div>
      `;
      exportContainer.innerHTML += recordHtml;
    });
    
    const canvas = await html2canvas(exportContainer, {
      scale: 2,
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#ffffff'
    });
    
    document.body.removeChild(exportContainer);
    
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4'
    });
    
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();
    const imgWidth = canvas.width;
    const imgHeight = canvas.height;
    const margin = 10;
    const availableWidth = pdfWidth - 2 * margin;
    const ratio = availableWidth / imgWidth;
    const scaledHeight = imgHeight * ratio;
    
    let heightLeft = scaledHeight;
    let position = margin;
    let pageCount = 0;
    
    pdf.addImage(imgData, 'PNG', margin, position, availableWidth, scaledHeight);
    heightLeft -= (pdfHeight - 2 * margin);
    pageCount++;
    
    while (heightLeft > 0) {
      position = -(pageCount * (pdfHeight - 2 * margin)) + margin;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', margin, position, availableWidth, scaledHeight);
      heightLeft -= (pdfHeight - 2 * margin);
      pageCount++;
    }
    
    pdf.save(`å¥åº·è®°å½•_${new Date().getTime()}.pdf`);
    alert('å¯¼å‡ºæˆåŠŸï¼');
  } catch (error) {
    console.error('å¯¼å‡ºå¤±è´¥:', error);
    alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
  } finally {
    isExporting.value = false;
  }
};

const closeSuccessModal = async () => {
  showSuccessModal.value = false;
  await loadCheckinHistory();
};

const closeAlreadyChecked = () => {
  showAlreadyChecked.value = false;
  router.push('/dashboard-metrics');
};

const checkIfAlreadyCheckedIn = async () => {
  try {
    const result = await checkTodayCheckin();
    if (result.hasCheckedIn) {
      todayCheckinTime.value = result.checkinTime || '';
      if (result.checkinData) {
        const data = result.checkinData;
        checkinData.value = {
          sleepHours: data.sleepHours ?? 8,
          sleepTime: data.sleepTime ?? '23:00',
          symptoms: Array.isArray(data.symptoms) ? data.symptoms : [],
          mood: data.mood ?? 2,
          exerciseMinutes: data.exerciseMinutes ?? 30,
          dietNotes: data.dietNotes ?? ''
        };
      }
      showAlreadyChecked.value = true;
    }
  } catch (error) {
    console.error('æ£€æŸ¥è®°å½•çŠ¶æ€å¤±è´¥:', error);
  }
};

const enterEditMode = () => {
  showAlreadyChecked.value = false;
  isEditMode.value = true;
};

const continueCheckin = async () => {
  showSuccessModal.value = false;
  await loadCheckinHistory();
};

const resetForm = () => {
  showResult.value = false;
  analysisResult.value = null;
  currentStep.value = 1;
  checkinData.value = {
    sleepHours: 8,
    sleepTime: '23:00',
    symptoms: [],
    mood: 2,
    exerciseMinutes: 30,
    dietNotes: ''
  };
};

const drawHealthChart = async () => {
  if (!chartCanvas.value) return;

  const ctx = chartCanvas.value.getContext('2d');
  if (!ctx) return;

  try {
    const trendsResponse = await getHealthTrends(7);
    const trendsData = trendsResponse.trends || [];

    ctx.clearRect(0, 0, 400, 200);
    ctx.strokeStyle = '#e9ecef';
    ctx.lineWidth = 1;

    ctx.beginPath();
    ctx.moveTo(40, 20);
    ctx.lineTo(40, 180);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(40, 180);
    ctx.lineTo(380, 180);
    ctx.stroke();

    if (trendsData.length > 0) {
      ctx.strokeStyle = '#42b983';
      ctx.lineWidth = 3;
      ctx.beginPath();

      trendsData.forEach((item: HealthTrend, index: number) => {
        const x = 60 + index * (320 / Math.max(trendsData.length - 1, 1));
        const y = 180 - ((item.healthScore || 70) - 50) * 2.6;

        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }

        ctx.fillStyle = '#ffffff';
        ctx.strokeStyle = '#42b983';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.stroke();

        ctx.fillStyle = '#42b983';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText((item.healthScore || 70).toString(), x, y - 10);
      });

      ctx.stroke();

      ctx.fillStyle = '#6c757d';
      ctx.font = '12px Arial';
      ctx.textAlign = 'center';

      trendsData.forEach((item: HealthTrend, index: number) => {
        const x = 60 + index * (320 / Math.max(trendsData.length - 1, 1));
        const date = new Date(item.date);
        const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
        const dayName = dayNames[date.getDay()];
        ctx.fillText(dayName || '', x, 195);
      });
    } else {
      ctx.fillStyle = '#6c757d';
      ctx.font = '14px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('æš‚æ— æ•°æ®ï¼Œè¯·å…ˆè¿›è¡Œè®°å½•', 200, 100);
    }
  } catch (error) {
    console.error('ç»˜åˆ¶å›¾è¡¨å¤±è´¥:', error);
    ctx.fillStyle = '#dc3545';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('æ•°æ®åŠ è½½å¤±è´¥', 200, 100);
  }
};

const loadCheckinHistory = async () => {
  try {
    let historyList: RawCheckinRecord[] = [];
    
    try {
        const summary = await getCheckinSummary();
        if (summary?.history) {
            historyList = summary.history as RawCheckinRecord[];
        }
    } catch (e) {
        console.warn('è·å–è¯¦ç»†å†å²å¤±è´¥ï¼Œå°è¯•è·å–è¶‹åŠ¿æ•°æ®', e);
    }

    if (historyList.length === 0) {
        const t = await getHealthTrends(7);
        historyList = (t?.trends ?? []) as RawCheckinRecord[];
    }

    checkinHistory.value = historyList.slice(-7).reverse().map((record) => {
      const date = record.date || record.checkin_date || record.checkinDate || '';
      const score = record.healthScore ?? record.health_score;
      const summary = record.summary ?? (score !== undefined ? `å¥åº·åˆ† ${score}` : 'å·²è®°å½•');
      
      let symptoms = record.symptoms;
      if (typeof symptoms === 'string') {
        try { symptoms = JSON.parse(symptoms); } catch {}
      }
      if (!Array.isArray(symptoms)) symptoms = [];

      return { 
        date, 
        healthScore: score, 
        summary,
        sleepHours: record.sleepHours ?? record.sleep_hours,
        sleepTime: record.sleepTime ?? record.sleep_time,
        symptoms: symptoms,
        mood: record.mood,
        exerciseMinutes: record.exerciseMinutes ?? record.exercise_minutes,
        dietNotes: record.dietNotes ?? record.diet_notes ?? record.diet,
        createdAt: record.createdAt ?? record.created_at
      } as HealthTrend;
    });
  } catch (err) {
    console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', err);
    checkinHistory.value = [];
  }
};

const getMoodInfo = (index: number | undefined) => {
  if (index === undefined || index < 0 || index >= moods.length) return { emoji: 'ğŸ¤”', name: 'æœªè®°å½•' };
  return moods[index] ?? { emoji: 'ğŸ¤”', name: 'æœªè®°å½•' };
};

const openDetailModal = (record: HealthTrend) => {
  selectedRecord.value = record;
  showDetailModal.value = true;
};

const closeDetailModal = () => {
  showDetailModal.value = false;
  setTimeout(() => {
    selectedRecord.value = null;
  }, 300);
};

onMounted(async () => {
  await checkIfAlreadyCheckedIn();
  loadCheckinHistory();
});

watch(showResult, async (v) => {
  if (v) {
    await nextTick();
    drawHealthChart();
  }
});
</script>

// ========================================
// ä¸Šé¢çš„ä»£ç æ·»åŠ åˆ°ç¬¬ 627 è¡Œä¹‹å
// ç„¶ååœ¨ä¸‹ä¸€è¡Œæ·»åŠ  <style scoped>
// ========================================
