# 测试健康分修复

## 测试步骤

### 1. 执行SQL脚本
```bash
# 连接到MySQL数据库
mysql -u root -p

# 选择数据库
use lingsu_health;

# 执行SQL脚本
source add_health_score_to_checkins.sql;

# 验证字段是否添加成功
DESC health_checkins;
# 应该能看到 health_score 字段

# 退出MySQL
exit;
```

### 2. 重启后端服务
```bash
# 停止当前运行的服务（如果有）
# 然后重新启动

# 使用Maven启动
cd /path/to/project
mvn clean spring-boot:run

# 或者使用jar包启动
mvn clean package
java -jar target/lingsu-health-0.0.1-SNAPSHOT.jar
```

### 3. 测试打卡功能

#### 测试场景1：同一天多次打卡，健康分应该不同

1. **第一次打卡**
   - 睡眠时长：5小时
   - 入睡时间：02:00
   - 情绪：一般
   - 运动时长：0分钟
   - 预期健康分：较低（约40-50分）

2. **第二次打卡**（同一天）
   - 睡眠时长：8小时
   - 入睡时间：22:30
   - 情绪：很好
   - 运动时长：45分钟
   - 预期健康分：较高（约85-95分）

3. **验证结果**
   - 查看历史记录，两条记录应该显示不同的健康分
   - 健康趋势图应该显示两个不同的数据点

#### 测试场景2：不同天打卡，健康分独立计算

1. 今天打卡一次（任意数据）
2. 明天再打卡一次（不同数据）
3. 验证两天的健康分独立计算，互不影响

#### 测试场景3：删除打卡记录

1. 删除某一天的打卡记录
2. 验证该记录从历史中消失
3. 验证健康趋势图更新正确

### 4. 验证数据库

```sql
-- 查看最近的打卡记录和健康分
SELECT 
    id,
    user_id,
    checkin_date,
    sleep_hours,
    mood,
    exercise_minutes,
    health_score,
    created_at
FROM health_checkins
ORDER BY created_at DESC
LIMIT 10;

-- 验证同一天的多条记录有不同的健康分
SELECT 
    checkin_date,
    COUNT(*) as count,
    GROUP_CONCAT(health_score) as scores
FROM health_checkins
WHERE user_id = 1  -- 替换为实际用户ID
GROUP BY checkin_date
HAVING count > 1;
```

## 预期结果

✅ **正确的行为：**
- 每次打卡都有独立的健康分
- 同一天多次打卡，每次的健康分可以不同
- 健康分根据当次打卡的数据计算（睡眠、情绪、运动、饮食）
- 删除打卡记录后，对应的健康分也被删除
- 健康趋势图正确显示历史数据

❌ **错误的行为（已修复）：**
- ~~同一天的所有打卡显示相同的健康分~~
- ~~新打卡会覆盖之前所有打卡的健康分~~
- ~~健康分存储在trends表而不是checkins表~~

## 健康分计算规则

健康分由以下几部分组成（总分100）：

1. **睡眠得分（30%）**
   - 7-8小时：100分
   - 6-7小时：80分
   - 8-9小时：85分
   - 5-6小时：60分
   - 入睡时间22:00-23:00最佳

2. **情绪得分（25%）**
   - 极佳：100分
   - 很好：85分
   - 良好：70分
   - 一般：50分
   - 很差：20分

3. **运动得分（25%）**
   - 30-60分钟：100分
   - 60-90分钟：95分
   - 20-30分钟：80分
   - 10-20分钟：60分
   - 0分钟：20分

4. **饮食得分（20%）**
   - 有记录：70分基础分
   - 包含"清淡"、"蔬菜"、"水果"：+15分
   - 包含"蛋白"、"鸡蛋"、"牛奶"：+10分
   - 包含"规律"、"三餐"：+10分
   - 包含"油炸"、"烧烤"、"外卖"：-15分

## 故障排查

### 问题1：后端启动报错 "Unknown column 'health_score'"
**原因：** SQL脚本未执行或执行失败
**解决：** 重新执行SQL脚本，确认字段添加成功

### 问题2：健康分显示为0
**原因：** 旧数据未迁移或计算逻辑有问题
**解决：** 
1. 检查数据库中health_score字段是否有值
2. 重新打卡一次，看新记录是否正常
3. 查看后端日志，确认计算逻辑执行

### 问题3：健康趋势图不显示
**原因：** 前端Canvas渲染问题或数据格式错误
**解决：**
1. 打开浏览器开发者工具，查看Console错误
2. 检查API返回的数据格式
3. 确认至少有一条打卡记录

## 技术细节

### 数据流程
1. 用户提交打卡 → POST /api/checkin
2. 后端计算健康分 → saveHealthTrend()
3. 设置到checkin对象 → checkin.setHealthScore()
4. 更新数据库 → healthCheckinMapper.updateById()
5. 返回给前端 → response.healthScore
6. 前端显示 → 结果页面 + 历史记录 + 趋势图

### 数据库表结构
```sql
-- health_checkins 表（主表）
CREATE TABLE health_checkins (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    checkin_date DATE NOT NULL,
    sleep_hours DECIMAL(3,1),
    sleep_time TIME,
    symptoms TEXT,
    mood INT,
    exercise_minutes INT,
    diet_notes TEXT,
    followed_plan BOOLEAN,
    health_score INT DEFAULT 0,  -- 新增字段
    analysis_summary TEXT,
    analysis_suggestions TEXT,
    analysis_risks TEXT,
    analysis_tomorrow_plan TEXT,
    analysis_tomorrow_tasks TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- health_trends 表（辅助表，用于趋势分析）
CREATE TABLE health_trends (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    trend_date DATE NOT NULL,
    health_score INT,
    sleep_quality_score INT,
    mood_score INT,
    exercise_score INT,
    diet_score INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```
