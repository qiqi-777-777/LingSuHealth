# 健康分修复说明

## 问题描述
之前每次打卡时，所有同一天的记录都显示相同的健康分，并且每次提交都会把之前的健康分改成最新的。

## 根本原因
健康分数据存储在 `health_trends` 表中，而不是 `health_checkins` 表。每天只有一条趋势记录，所以同一天的多次打卡共享同一个健康分。

## 解决方案
1. 在 `health_checkins` 表中添加 `health_score` 字段
2. 每次打卡时，将计算出的健康分直接保存到打卡记录中
3. 前端从打卡记录读取健康分，而不是从趋势表读取

## 需要执行的步骤

### 1. 执行SQL脚本（必须）
连接到MySQL数据库，执行以下SQL：

```sql
-- 添加 health_score 字段到 health_checkins 表
ALTER TABLE health_checkins 
ADD COLUMN health_score INT DEFAULT 0 COMMENT '综合健康分(0-100)' 
AFTER followed_plan;

-- 为现有记录填充健康分（从health_trends表复制）
UPDATE health_checkins hc
LEFT JOIN health_trends ht ON hc.user_id = ht.user_id AND hc.checkin_date = ht.trend_date
SET hc.health_score = COALESCE(ht.health_score, 0)
WHERE hc.health_score IS NULL OR hc.health_score = 0;
```

**执行方法：**
```bash
# 方法1：使用MySQL命令行
mysql -u root -p lingsu_health < add_health_score_to_checkins.sql

# 方法2：登录MySQL后执行
mysql -u root -p
use lingsu_health;
source add_health_score_to_checkins.sql;

# 方法3：使用数据库管理工具（如Navicat、DBeaver等）
# 打开工具，连接数据库，执行SQL脚本
```

### 2. 重启后端服务
执行SQL后，需要重启Spring Boot应用：

```bash
# 如果使用Maven运行
mvn spring-boot:run

# 如果使用jar包
java -jar target/lingsu-health-0.0.1-SNAPSHOT.jar
```

### 3. 测试验证
1. 打开前端页面，进行一次打卡
2. 再进行第二次打卡（不同的睡眠时长或其他参数）
3. 查看历史记录，确认两次打卡的健康分不同
4. 查看健康趋势图，确认显示正确

## 代码修改说明

### 后端修改
1. **HealthCheckin.java** - 添加了 `healthScore` 字段
2. **HealthCheckinService.java** - 修改 `saveHealthTrend()` 方法，将健康分设置到checkin对象上，并在保存后调用 `updateById()` 更新
3. **CheckinController.java** - 修改 `trends` 端点，直接从 `HealthCheckin` 读取健康分

### 前端修改
1. **Checkin.vue** - 添加了 `drawHealthChart()` 方法，使用Canvas绘制健康趋势图
2. 趋势图显示最近7天的健康分变化

## 预期效果
- ✅ 每次打卡都有独立的健康分
- ✅ 同一天多次打卡，每次的健康分可以不同
- ✅ 健康趋势图正确显示历史数据
- ✅ 不会出现"提交后把之前的健康分都改了"的问题

## 注意事项
- 必须先执行SQL脚本，否则后端会报错（字段不存在）
- 执行SQL后必须重启后端服务
- 旧的打卡记录会从 `health_trends` 表复制健康分数据
